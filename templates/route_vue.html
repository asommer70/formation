
<script type="text/javascript">
 // Vue.use(VAutocomplete.default)

 Vue.component('autocomplete', {
   delimiters: ["<%","%>"],
   props: ['name', 'title', 'items', 'label', 'disabled'],
   data: function() {
     return {
       item: '',
     }
   },

   computed: {
     dropdownId: function() {
       return 'dd_' + Math.floor((Math.random() * 1000) + 1);
     },

     inputId: function() {
       return 'input_' + this.dropdownId;
     },

     filteredItems: {
       get: function() {
	 var self = this;
	 if (this.item != '' && typeof(this.item) !== 'object') {
	   var regexp = new RegExp(this.item, 'ig');
	   var filtered = self.items.filter(function(val) {
	     return regexp.test(val[self.label]);
	   });
	   return filtered;
         }
	 return this.items;
       },

       set: function(items) {
	 return items;
       }
     },

     isDisabled: function() {
       return this.disabled === 'disabled';
     }
   },
   
   template: `
     <div>
       <label :for="inputId"><% title %></label>
       <input type="text" v-model="item" :name="name" @keydown="filterItems" :data-toggle="dropdownId" :id="inputId" :disabled="isDisabled" />
       <div class="dropdown-pane" :id="dropdownId" data-dropdown>
	 <ul class="no-bullet">
	   <li v-for="item in filteredItems" @click="setItem(item)">
	     <% item[label] %>
	   </li>
	 </ul>
       </div>
     </div>
   `,

   methods: {
     filterItems: function(event) {
       this.item = event.target.value;
       if (event.target.value === "") {
	 this.setItem("");
       }
     },

     setItem: function(item) {
       this.item = item[this.label];
       $('#' + this.dropdownId).foundation('close');

       // Emit event to disable the other option.
       this.$emit('item-chosen', item);
     }
   }
 });

 Vue.component('destination', function(resolve) {
   resolve({
     delimiters: ["<%","%>"],
     data: function() {
       return {
	 user: '',
	 group: ''
       }
     },
     props: ['name', 'userLabels', 'groupLabels', 'users', 'groups', 'isRemoveable'],
     template: `
       <div class="card route-dest-card">
	 <div v-bind:class="[isRemoveable ? 'card-section' : 'card-divider']">
	   <span class="float-left"><% name %></span>
	   <button type="button" v-if="isRemoveable" class="button tiny secondary float-right">&times;</button>
	   <hr v-if="isRemoveable" />
	 </div>
	 <div class="card-section">
	   <autocomplete @item-chosen="setUser" @blur="setUser" :disabled="user" :name="name" title="User" :items="users" label="username"></autocomplete>
	   
	   <autocomplete @item-chosen="setGroup" @blur="setGroup" :disabled="group" :name="name" title="Group" :items="groups" label="name"></autocomplete>
	 </div>
       </div>
     `
     ,

     methods: {
       setUser: function(item) {
         this.user = item;

	 if (item !== "") {
	   this.group = 'disabled';
	 } else {
	   this.group = '';
	 }
	 this.$forceUpdate();
       },

       setGroup: function(item) {
	 this.group = item;

	 if (item !== "") {
	   this.user = 'disabled';
	 } else {
	   this.user = '';
	 }
	 this.$forceUpdate();
       }
     },

     components: {name: 'autocomplete'}
   });
 });
 
 var app = new Vue({
   el: '#route-form',
   delimiters: ["<%","%>"],
   created: function() {
     // Add the start and first destination...
   },
   
   data: {
     userName: '',
     groupName: '',
     destCount: 1,
     userLabels: [
       {% for user in users %}
       '{{user.username}}',
       {% endfor %}
     ],
     groupLabels: [
       {% for group in groups %}
       '{{group.name}}',
       {% endfor %}
     ],
     users: [
       {% for user in users %}
       {
	 id: {{user.id}},
	 username: '{{user.username}}',
	 email: '{{user.email}}'
       },
       {% endfor %}
     ],
     groups: [
       {% for group in groups %}
       {
	 id: {{group.id}},
	 name: '{{group.name}}'
       },
       {% endfor %}
     ],
   },
   
   computed: {
     pathParts: function() {
       return window.location.pathname.split('/');
     },

     dests: {
       get: function() {
	 return [
	   {name: 'Start', userLabels: this.userLabels, groupLabels: this.groupLabels, users: this.users, groups: this.groups, isRemoveable: false},
	   {name: 'Destination 1', userLabels: this.userLabels, groupLabels: this.groupLabels, users: this.users, groups: this.groups, isRemoveable: false},
	 ];
       },
       
       set: function(dest) {
	 this.dests.push(dest);
       }
     },
   },

   methods: {
     addDest: function(event) {
       this.destCount = this.destCount + 1;

       // <autocomplete @item-chosen="setUser" @blur="setUser" :disabled="user" :name="name" title="User" :items="users" label="username"></autocomplete>

       this.dests = {
	 name: 'Destination ' + this.destCount,
	 userLabels: this.userLabels,
	 groupLabels: this.groupLabels,
	 users: this.users,
	 groups: this.groups,
	 isRemoveable: true
       };

       // TODO:as send Ajax request to create a new Destination object.

       // Need to force a rerender I guess due to dests being a computed property...
       this.$forceUpdate();
     },

     getAutoComponent: function(userName) {
       // Needed for v-autocomplete.
       console.log('getAutoComponent userName:', userName);
     },
     
     getUsername: function(username, label) {
       console.log('getUsername username:', username, 'label:', label);
       this.userName = username;

       if (this.users[username]) {
	 return this.users[username].username;
       }

       return '';
     },

     getGroupname: function(groupname) {
       this.groupName = groupname;
       
       if (this.groups[groupname]) {
	 return this.groups[groupname].name;
       } else {
	 return '';
       }
     }
   },

   components: { name: 'destination', name: 'autocomplete' },
 });
</script>
