<script type="text/javascript">
 Vue.use(VAutocomplete.default)

 Vue.component('destination', function(resolve) {
   resolve({
     delimiters: ["<%","%>"],
     data: function() {
       return {
	 userName: '',
	 groupName: ''
       }
     },
     props: ['name', 'userLabels', 'groupLabels', 'users', 'groups', 'isRemoveable'],
     template: `
       <div class="card route-dest-card">
	 <div v-bind:class="[isRemoveable ? 'card-section' : 'card-divider']">
	   <span class="float-left"><% name %></span>
	   <button type="button" v-if="isRemoveable" class="button tiny secondary float-right">&times;</button>
	   <hr v-if="isRemoveable" />
	 </div>
	 <div class="card-section">
	   <label>User</label>
	   <v-autocomplete 
	     :items="userLabels"
	     v-model="userName"
	     :get-label="getUsername"
	     :component-item='getAutoComponent(userName)' />

	     <label>Group</label>
	     <v-autocomplete
	       :items="groupLabels"
	       v-model="groupName"
	       :get-label="getGroupName"
	       :component-item='getAutoComponent(groupName)' />
	 </div>
       </div>
     `,

     methods: {
       getAutoComponent: function(item) {
	 // Needed for v-autocomplete.
       },
       
       getUsername: function(username, label) {
	 this.userName = username;

	 if (this.users[username]) {
	   return this.users[username].username;
	 } else {
	   return '';
	 }
       },

       getGroupName: function(groupname) {
	 this.groupName = groupname;
	 
	 if (this.groups[groupname]) {
	   return this.groups[groupname].name;
	 } else {
	   return '';
	 }
       }
     }
   });
 });
 
 var app = new Vue({
   el: '#route-form',
   delimiters: ["<%","%>"],
   created: function() {
     // Add the start and first destination...
   },
   
   data: {
     destCount: 1,
     userLabels: [
       {% for user in users %}
       '{{user.username}}',
       {% endfor %}
     ],
     groupLabels: [
       {% for group in groups %}
       '{{group.name}}',
       {% endfor %}
     ],
     users: {
       {% for user in users %}
       {{user.username}}: {
	 id: {{user.id}},
	 username: '{{user.username}}',
	 email: '{{user.email}}'
       },
       {% endfor %}
     },
     groups: {
       {% for group in groups %}
       {{group.name}}: {
	 id: {{group.id}},
	 name: '{{group.name}}'
       },
       {% endfor %}
     },
   },
   
   computed: {
     pathParts: function() {
       return window.location.pathname.split('/');
     },

     dests: {
       get: function() {
	 return [
	   {name: 'Start', userLabels: this.userLabels, groupLabels: this.groupLabels, users: this.users, groups: this.groups, isRemoveable: false},
	   {name: 'Destination 1', userLabels: this.userLabels, groupLabels: this.groupLabels, users: this.users, groups: this.groups, isRemoveable: false},
	 ];
       },
       
       set: function(dest) {
	 this.dests.push(dest);
       }
     },
   },

   methods: {
     addDest: function(event) {
       this.destCount = this.destCount + 1;

       this.dests = {
	 name: 'Destination ' + this.destCount,
	 userLabels: this.userLabels,
	 groupLabels: this.groupLabels,
	 users: this.users,
	 groups: this.groups,
	 isRemoveable: true
       };

       // TODO:as send Ajax request to create a new Destination object.

       // Need to force a rerender I guess due to dests being a computed property...
       this.$forceUpdate();
     }
   },

   components: { name: 'destination' },
 });
</script>
