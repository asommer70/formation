<script type="text/javascript">

 Vue.component('autocomplete', {
   delimiters: ["<%","%>"],
   props: ['name', 'title', 'destitem', 'items', 'label', 'disabled'],
   data: function() {
     return {
       filteredItem: '',
     }
   },

   computed: {
     item: {
       get: function() {
	 return this.filteredItem;
       },
       set: function(item) {
	 this.filteredItem = item;
       }
     },
     
     dropdownId: function() {
       var dropdownId = 'dd_' + Math.floor((Math.random() * 1000) + 1);
       return dropdownId;
     },

     inputId: function() {
       return 'input_' + this.dropdownId;
     },

     filteredItems: {
       get: function() {
	 var self = this;
	 if (this.item !== '' && typeof(this.item) !== 'object') {
	   var regexp = new RegExp(this.item, 'ig');
	   return self.items.filter(function(val) {
	     return regexp.test(val[self.label]);
	   });
         }
	 
	 return this.items;
       },

       set: function(items) {
	 return items;
       }
     },

     isDisabled: function() {
       return this.disabled === 'disabled';
     }
   },
   
   template: `
     <div>
       <input type="text" 
	      v-model="item" 
              :name="name" 
              @keydown="filterItems" 
              :data-toggle="dropdownId" 
              :id="inputId" 
	      autocomplete="off" 
              :placeholder="title" />
     <div class="dropdown-pane" :id="dropdownId" data-dropdown>
	 <ul class="no-bullet">
	   <li v-for="item in filteredItems" @click="setItem(item)">
	     <% item[label] %>
	   </li>
	 </ul>
     </div>
     </div>
   `,

   methods: {
     filterItems: function(event) {
       this.item = event.target.value;
       if (event.target.value === "") {
	 this.setItem("");
       }
     },

     setItem: function(item) {
       this.item = item[this.label];
       
       // Emit event to disable the other option.
       // this.$emit('item-chosen', item);
     }
   },

   created: function() {
     /* if (this.destitem) {
      *   if (this.destitem.hasOwnProperty('username')) {
	this.filteredItem = this.destitem.username;
      *   } else if (this.destitem.hasOwnProperty('name')) {
	this.filteredItem = this.destitem.name;
      *   }
      * } */
   }
 });
 
 var app = new Vue({
   el: '.form-content',     
   data: {% autoescape off %}{{data}}{% endautoescape %},

   computed: {
     pathParts: function() {
       return window.location.pathname.split('/');
     },

     users: function() {
       return [
	 {% for user in users %}
	 {
	   id: {{user.id}},
	   username: '{{user.username}}',
	   email: '{{user.email}}'
	 },
	 {% endfor %}
       ];
     },

     routes: function() {
       {% if input.status == 'new' %}
       return [{% for route in input.form.route_set.all %}
	       {
		 id: {{route.id}},
		 dests: [{% for dest in route.destination_set.all %}
			 {
			   id: {{dest.id}},
			   user: {% if dest.user %}"{{dest.user.username}}"{% else %}""{% endif %},
			   group: {% if dest.group %}
				  {
				    id: {{dest.group.id}},
				    name: "{{dest.group.name}}",
				    members: [
				      {% for user in dest.group.user_set.all %}
				      {id: {{user.id}}, username: "{{user.username}}"},
				      {% endfor %}
				    ],
				  }
			   {% else %}
			   ""
			   {% endif %},
			   step: {{dest.step}},
			   inputStep: {{input.step}},
			   name: "{{dest.name}}"
			 },
		 {% endfor %}]
	       },
       {% endfor %}];
       {% else %}
       return {};
       {% endif %}
     },

     {% if input %}
     input: function() {
       return {
	 id: {{input.id}},
	 step: {{input.step}},
	 current_dest: {% if input.status == 'routed' %}{{input.current_dest.id}}{% else %}false{% endif %},
	 route_holder: {% if input.route_holder %}{{input.route_holder.id}}{% else %}{{input.user.id}}{% endif %},
         route_sender: {% if input.route_sender %}{{input.route_sender.id}}{% else %}{{input.user.id}}{% endif %},
       }
     }
     {% endif %}
   },
   
   methods: {
     submitForm: function(event) {
       // Serialize form into a JSON object to send to /inbox/create.
       var self = this;
       var $form = $('#input-form');
       var formData = $form.serializeObject();
       var data = {
	 form: $form.attr('name'),
	 data: JSON.stringify(formData),
	 user: userId
       };

       var url, method;
       if (this.pathParts[this.pathParts.length - 1] !== "" && this.pathParts[1] !== 'forms' && this.pathParts[this.pathParts.length - 1] !== "Delete") {
	 url = '/api/inbox/' + this.pathParts[this.pathParts.length - 1];
	 method = 'put';
       } else {
	 url = '/api/inbox/';
	 method = 'post';
       }
       
       $.ajax({
	 url: url,
	 method: method,
	 data: data,
	 headers: {
	   Authorization: 'Token ' + token,
	   contentType: 'application/json; charset=utf-8'
	 },
	 success: function(data) {
	   console.log('post data:', data);
	   localStorage.setItem('form_' + self.pathParts[self.pathParts.length - 1], null);
	   window.location.href = '/inbox/' + data.id;
	 }
       });
     },
     
     saveInput: function(event) {
       var inputData = JSON.parse(localStorage.getItem('form_' + this.pathParts[this.pathParts.length - 1])) || {};
       inputData[event.target.name] = event.target.value;
       localStorage.setItem('form_' + this.pathParts[this.pathParts.length - 1], JSON.stringify(inputData));
     },

     setUser: function(event) {
       console.log('app setUser...');
     },

     routeForm: function(event) {
       console.log('app routeForm... event:', event);
     }
   },

   mounted: function() {
     var self = this;
     var data = JSON.parse(localStorage.getItem('form_' + this.pathParts[this.pathParts.length - 1]));
     if (data !== 'null' && data !== null && data !== 'undefined') {
       $.each(data, function(k, v) {
	 self[k] = v;
       });
     }

     // Set the scroll height of all textarea elements to match their contents.
     $.each($('textarea'), function(idx, el) {
       var $el = $(el);
       $el.height($el.prop('scrollHeight'));
     });
   }
 });
</script>
